# 实现计划

- [ ] 1. 添加 ulule/limiter 依赖并扩展配置结构

  - 使用 go get 命令添加 ulule/limiter/v3 依赖
  - 扩展 Config 结构体添加 RateLimit 配置字段
  - 为限流配置设置合理的默认值
  - _需求: 3.1, 3.2, 4.1_

- [ ] 2. 实现限流器初始化函数

  - 创建 initRateLimiters 函数使用 ulule/limiter 组件
  - 实现 IP 和 post_key 的键提取器函数
  - 配置内存存储和四个限流器实例（IP 分钟/日，post_key 分钟/日）
  - 返回 Gin 中间件数组用于路由注册
  - _需求: 4.1, 4.2, 4.3_

- [ ] 3. 扩展配置文件支持限流参数

  - 在 config.toml 中添加 [rate_limit] 配置段
  - 添加 IP 和 post_key 的分钟级和日级限制配置
  - 更新 LoadConfig 函数解析新的配置字段
  - 添加配置验证逻辑确保限流参数有效
  - _需求: 3.1, 3.2, 3.3, 3.4_

- [ ] 4. 集成限流中间件到路由配置

  - 修改 SetupRoutes 函数调用 initRateLimiters
  - 仅对 create post 路由（POST /:post_key）应用限流中间件
  - 实现错误处理确保限流器初始化失败时服务仍可用
  - 保持限流中间件在认证中间件之前的执行顺序
  - _需求: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4_

- [ ] 5. 实现自定义错误处理器

  - 创建 withCustomErrorHandler 函数处理限流系统错误
  - 创建 withCustomLimitReachedHandler 函数自定义限流响应格式
  - 确保错误响应包含清晰的中文错误信息
  - 添加结构化日志记录限流事件
  - _需求: 5.1, 5.2, 5.3, 5.4, 6.1, 6.2_

- [ ] 6. 更新主程序集成限流功能

  - 在 main.go 中保持现有全局限流器配置
  - 确保新的 create post 限流与现有限流器兼容
  - 添加限流器初始化的日志输出
  - 验证所有中间件按正确顺序执行
  - _需求: 4.4, 6.3_

- [ ] 7. 添加限流状态监控和日志

  - 实现限流事件的结构化日志记录
  - 记录 IP 和 post_key 超限事件的详细信息
  - 添加限流器内存使用情况的监控日志
  - 确保日志不影响正常请求的性能
  - _需求: 6.1, 6.2, 6.3, 6.4_
